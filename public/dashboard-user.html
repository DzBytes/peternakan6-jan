<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pesanan Saya - Berkah Farm</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div id="navbar-container"></div>

    <div class="dashboard-container">
        <h2 style="margin-bottom: 25px;"><i class="fas fa-list-alt"></i> Riwayat Pesanan Saya</h2>
        <div id="pesananContainer">
            <div style="text-align: center; padding: 50px;">
                <i class="fas fa-spinner fa-spin fa-2x"></i><br>Memuat pesanan...
            </div>
        </div>
    </div>

    <script src="js/navbar.js"></script>
    <script>
        const userId = localStorage.getItem('user_id');

        document.addEventListener('DOMContentLoaded', () => {
            if (!userId) window.location.href = 'login.html';
            loadPesanan();
        });

        async function loadPesanan() {
            try {
                const response = await fetch(`http://localhost:3000/api/pesanan?user_id=${userId}`);
                const data = await response.json();
                renderPesanan(data);
            } catch (error) {
                document.getElementById('pesananContainer').innerHTML = `<p style="color:red">Gagal memuat data.</p>`;
            }
        }

        function renderPesanan(list) {
            const container = document.getElementById('pesananContainer');
            container.innerHTML = ''; 

            if(list.length === 0) {
                container.innerHTML = `
                    <div class="glass-card" style="text-align:center; padding: 40px;">
                        <i class="fas fa-box-open fa-3x" style="color: var(--text-muted); margin-bottom: 20px;"></i>
                        <p>Belum ada pesanan.</p>
                        <a href="katalog.html" class="btn-primary" style="margin-top: 15px;">Lihat Katalog</a>
                    </div>`;
                return;
            }

            list.forEach(item => {
                const date = new Date(item.tanggal_pemesanan).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
                const price = parseInt(item.total_harga).toLocaleString('id-ID');
                
                // Logic Info Tambahan (Untuk siapa Qurban/Aqiqah)
                let extraInfo = '';
                if(item.tipe_ibadah && item.tipe_ibadah.includes('qurban')) {
                    extraInfo = `<div style="font-size:0.85rem; color:#f1c40f; margin-top:5px"><i class="fas fa-user-tag"></i> Qurban a.n: <b>${item.nama_shohibul_qurban || '-'}</b></div>`;
                } else if(item.tipe_ibadah === 'aqiqah') {
                    extraInfo = `<div style="font-size:0.85rem; color:#9b59b6; margin-top:5px"><i class="fas fa-baby"></i> Aqiqah Anak: <b>${item.nama_anak || '-'}</b></div>`;
                }

                // Logic Tombol Aksi
                let actionBtn = '';
                
            if (item.metode_bayar === 'cicilan') {
                if (item.status_pesanan === 'selesai') {
                    actionBtn = `<button class="btn-secondary" style="cursor:default">Lunas</button>`;
                } else {
                    // PERUBAHAN DISINI: Text Button diganti
                    actionBtn = `<a href="dashboard-cicilan.html" class="btn-upload-cicilan"><i class="fas fa-wallet"></i> Lihat Cicilan</a>`;                    }
                } else {
                    // Jika Cash
                    if (['pending', 'belum_bayar'].includes(item.status_pesanan)) {
                        actionBtn = `<a href="pembayaran.html?id=${item.id}" class="btn-bayar">Bayar Sekarang</a>`;
                    } else if (['dibayar', 'menunggu_verifikasi'].includes(item.status_pesanan)) {
                        actionBtn = `<span style="color:#3498db; font-size:0.9rem"><i class="fas fa-clock"></i> Verifikasi Admin</span>`;
                    } else if (item.status_pesanan === 'selesai') {
                        actionBtn = `<a href="user-jadwal.html" class="btn-primary" style="background:var(--info-color)"><i class="fas fa-truck"></i> Cek Jadwal</a>`;
                    }
                }

                // Logic Badge Status
                let statusBadge = item.status_pesanan.toUpperCase().replace('_', ' ');
                let badgeColor = 'var(--text-muted)';
                if(item.status_pesanan === 'selesai') badgeColor = 'var(--primary-color)';
                if(item.status_pesanan === 'dibayar') badgeColor = '#3498db';
                if(item.status_pesanan === 'pending') badgeColor = '#f1c40f';

                container.innerHTML += `
                    <div class="glass-card pesanan-card" style="display:flex; flex-wrap:wrap; gap:20px; align-items:center;">
                        <img src="/uploads/hewan/${item.gambar || 'default.jpg'}" style="width:80px; height:80px; border-radius:10px; object-fit:cover;" onerror="this.src='images/default-hewan.jpg'">
                        
                        <div style="flex:1; min-width:200px;">
                            <h3 style="font-size:1.2rem; margin-bottom:5px;">${item.jenis_hewan} <span style="font-size:0.9rem; font-weight:normal; color:var(--text-muted)">(${item.jumlah} ekor)</span></h3>
                            <div style="color:var(--accent-green); font-weight:bold; font-size:1.1rem;">Rp ${price}</div>
                            ${extraInfo}
                            <div style="font-size:0.8rem; color:var(--text-muted); margin-top:5px;">${date} â€¢ Metode: ${item.metode_bayar.toUpperCase()}</div>
                        </div>

                        <div style="text-align:right; min-width:120px;">
                            <div style="margin-bottom:10px; font-weight:bold; color:${badgeColor}; border:1px solid ${badgeColor}; display:inline-block; padding:3px 10px; border-radius:15px; font-size:0.75rem;">
                                ${statusBadge}
                            </div>
                            <div>${actionBtn}</div>
                        </div>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>