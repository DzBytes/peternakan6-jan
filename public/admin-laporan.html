<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Laporan Keuangan - Admin</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container" style="padding: 2rem;">
        <h2>Laporan Keuangan & Penjualan</h2>

        <div class="dashboard-grid" style="margin-bottom: 30px;">
            <div class="glass-card">
                <i class="fas fa-coins" style="font-size: 2rem; color: var(--accent-green); margin-bottom:10px;"></i>
                <p class="card-title">Total Pemasukan</p>
                <h2 id="total-uang" style="color:white;">Rp 0</h2>
            </div>
            <div class="glass-card">
                <i class="fas fa-handshake" style="font-size: 2rem; color: var(--accent-green); margin-bottom:10px;"></i>
                <p class="card-title">Total Transaksi Selesai</p>
                <h2 id="total-transaksi" style="color:white;">0</h2>
            </div>
        </div>

        <div class="glass-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3>Rincian Transaksi Masuk</h3>
                
                <button onclick="downloadExcel()" class="btn-primary" style="width: auto; padding: 10px 20px;">
                    <i class="fas fa-file-excel"></i> Download Excel
                </button>
            </div>

            <table class="glass-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tanggal</th>
                        <th>Keterangan</th>
                        <th>Nominal</th>
                    </tr>
                </thead>
                <tbody id="tabel-laporan">
                    </tbody>
            </table>
        </div>
    </div>

    <script src="js/navbar.js"></script>
    <script>
        // Variabel global untuk menyimpan data agar bisa diakses fungsi download
        let laporanDataGlobal = [];

        async function loadLaporan() {
            try {
                const response = await fetch('http://localhost:3000/api/admin/pesanan');
                const data = await response.json();

                // Filter hanya yang statusnya 'selesai' (Uang sudah masuk)
                const dataSelesai = data.filter(item => item.status_pesanan === 'selesai');
                
                // Simpan ke variabel global untuk Excel
                laporanDataGlobal = dataSelesai;

                // Hitung Total & Render Tabel
                let totalUang = 0;
                const tbody = document.getElementById('tabel-laporan');
                tbody.innerHTML = ''; // Reset isi tabel
                
                if (dataSelesai.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Belum ada data keuangan.</td></tr>';
                    return;
                }

                dataSelesai.forEach(item => {
                    totalUang += parseFloat(item.total_harga); // Gunakan parseFloat biar aman
                    
                    // Format Tanggal
                    const tgl = new Date(item.tanggal_pemesanan).toLocaleDateString('id-ID');

                    tbody.innerHTML += `
                        <tr>
                            <td>#${item.id}</td>
                            <td>${tgl}</td>
                            <td>
                                <b>${item.nama_lengkap}</b><br>
                                <span style="font-size:0.85rem; color:#aaa;">${item.jenis_hewan} (${item.jumlah} ekor)</span>
                            </td>
                            <td style="color: var(--accent-green);">+ Rp ${parseInt(item.total_harga).toLocaleString('id-ID')}</td>
                        </tr>
                    `;
                });

                document.getElementById('total-uang').innerText = "Rp " + totalUang.toLocaleString('id-ID');
                document.getElementById('total-transaksi').innerText = dataSelesai.length + " Transaksi";

            } catch (error) {
                console.error("Gagal memuat laporan:", error);
            }
        }

        // --- FUNGSI DOWNLOAD EXCEL ---
        function downloadExcel() {
            if (laporanDataGlobal.length === 0) {
                alert("Tidak ada data untuk diekspor!");
                return;
            }

            // 1. Format Data Ulang (Supaya Rapi di Excel)
            const dataUntukExcel = laporanDataGlobal.map(item => ({
                "ID Pesanan": item.id,
                "Tanggal": new Date(item.tanggal_pemesanan).toLocaleDateString('id-ID'),
                "Nama Pelanggan": item.nama_lengkap,
                "Hewan": item.jenis_hewan,
                "Jumlah (Ekor)": item.jumlah,
                "Total Masuk (Rp)": parseFloat(item.total_harga) // Penting: Biar terbaca angka di Excel
            }));

            // 2. Buat Worksheet Baru
            const ws = XLSX.utils.json_to_sheet(dataUntukExcel);

            // 3. Atur Lebar Kolom (Opsional, biar cantik)
            const wscols = [
                {wch: 10}, // Lebar kolom ID
                {wch: 15}, // Lebar kolom Tanggal
                {wch: 25}, // Lebar kolom Nama
                {wch: 20}, // Lebar kolom Hewan
                {wch: 10}, // Lebar kolom Jumlah
                {wch: 20}  // Lebar kolom Harga
            ];
            ws['!cols'] = wscols;

            // 4. Buat Workbook dan Download
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan Keuangan");

            // Nama file dengan tanggal hari ini
            const filename = `Laporan_Keuangan_BerkahFarm_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, filename);
        }

        // Jalankan saat halaman dibuka
        loadLaporan();
    </script>
</body>
</html>