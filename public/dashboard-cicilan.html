<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Kelola Cicilan - Berkah Farm</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Gaya Kartu Transaksi Utama */
        .transaction-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            margin-bottom: 25px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .transaction-header {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        .transaction-header:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        .hewan-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid var(--accent-green);
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            margin-bottom: 5px;
        }

        .transaction-meta {
            color: var(--text-gray);
            font-size: 0.9rem;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        /* Progress Bar Cicilan */
        .progress-container {
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.1);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            width: 100%;
            max-width: 300px;
        }

        .progress-bar {
            height: 100%;
            background: var(--accent-green);
            width: 0%;
            transition: width 1s ease-in-out;
        }

        /* Area Daftar Cicilan (Accordion) */
        .installment-list {
            display: none; /* Hidden by default */
            padding: 20px;
            background: rgba(0, 0, 0, 0.1);
            border-top: 1px solid var(--card-border);
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Item Cicilan Per Bulan */
        .installment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .installment-item:last-child {
            border-bottom: none;
        }

        .installment-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .month-indicator {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .month-circle {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--text-gray);
        }

        .item-lunas .month-circle {
            background: var(--accent-green);
            color: black;
        }

        .item-telat .month-circle {
            background: #e74c3c;
            color: white;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .badge-lunas { background: rgba(46, 204, 113, 0.2); color: #2ecc71; }
        .badge-pending { background: rgba(241, 196, 15, 0.2); color: #f1c40f; }
        .badge-verif { background: rgba(52, 152, 219, 0.2); color: #3498db; }
        
        .toggle-icon {
            transition: transform 0.3s;
        }
        .expanded .toggle-icon {
            transform: rotate(180deg);
        }

        /* Modal Styles (Tetap sama) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; border: 1px solid #333; }
        .nominal-display { font-size: 1.5rem; color: var(--accent-green); text-align: center; margin: 15px 0; font-weight: bold; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .transaction-header { flex-direction: column; text-align: center; }
            .installment-item { flex-direction: column; gap: 10px; text-align: center; }
            .month-indicator { flex-direction: column; gap: 5px; }
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container" style="padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div>
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-wallet"></i> Transaksi Cicilan
                </h2>
                <p style="color: var(--text-gray);">Kelola pembayaran hewan kurban Anda</p>
            </div>
            <a href="dashboard-user.html" class="btn-secondary" style="text-decoration: none; padding: 8px 15px; border-radius: 8px; border: 1px solid #444; color: white;">
                <i class="fas fa-arrow-left"></i> Kembali
            </a>
        </div>

        <div id="transactionContainer">
            <div style="text-align: center; padding: 40px;">
                <div class="loading-spinner"></div>
                <p>Memuat data cicilan...</p>
            </div>
        </div>
    </div>

    <div id="modalBayar" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                <h3 style="margin: 0;">Bayar Cicilan</h3>
                <span onclick="closeModal()" style="cursor: pointer; font-size: 1.5rem;">&times;</span>
            </div>
            
            <form id="formBayarCicilan">
                <input type="hidden" id="modalPesananId">
                <input type="hidden" id="modalAngsuranKe">

                <div style="text-align: center; margin-bottom: 20px;">
                    <p style="color: var(--text-gray); margin-bottom: 5px;">Total Tagihan</p>
                    <div id="modalNominal" class="nominal-display">Rp 0</div>
                    <div id="modalInfoJatuhTempo" style="font-size: 0.9rem; color: #f1c40f;"></div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px;">Upload Bukti Transfer</label>
                    <input type="file" id="modalBukti" accept="image/*" required style="width: 100%; padding: 10px; background: #333; border-radius: 5px; border: 1px solid #555; color: white;">
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeModal()" style="padding: 10px 20px; border-radius: 8px; background: transparent; border: 1px solid #555; color: white; cursor: pointer;">Batal</button>
                    <button type="submit" id="btnSubmitBayar" style="padding: 10px 20px; border-radius: 8px; background: var(--accent-green); border: none; color: black; font-weight: bold; cursor: pointer;">
                        Kirim Pembayaran
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/navbar.js"></script>
    <script>
        const userId = localStorage.getItem('user_id');

        document.addEventListener('DOMContentLoaded', () => {
            if (!userId) window.location.href = 'login.html';
            loadTransactions();
        });

        // 1. Memuat Daftar Transaksi (Pesanan dengan metode cicilan)
        async function loadTransactions() {
            const container = document.getElementById('transactionContainer');
            try {
                // Ambil semua pesanan user
                const response = await fetch(`/api/pesanan?user_id=${userId}`);
                const pesanan = await response.json();
                
                // Filter hanya yang cicilan dan belum batal
                const cicilanOrders = pesanan.filter(p => 
                    p.metode_bayar === 'cicilan' && 
                    p.status_pesanan !== 'dibatalkan'
                );

                if (cicilanOrders.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 50px; border: 1px dashed #444; border-radius: 15px;">
                            <i class="fas fa-receipt" style="font-size: 3rem; color: #444; margin-bottom: 20px;"></i>
                            <h3>Belum ada cicilan aktif</h3>
                            <p style="color: var(--text-gray);">Anda belum memiliki transaksi dengan metode cicilan.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = ''; // Clear loading

                // Render setiap kartu transaksi
                for (const order of cicilanOrders) {
                    const detail = await fetchCicilanDetail(order.id);
                    renderTransactionCard(order, detail);
                }

            } catch (error) {
                console.error(error);
                container.innerHTML = '<p style="text-align:center; color: #e74c3c;">Gagal memuat data.</p>';
            }
        }

        // 2. Ambil detail cicilan (daftar bulan) dari API
        async function fetchCicilanDetail(pesananId) {
            try {
                const res = await fetch(`/api/pesanan/${pesananId}/cicilan`);
                const data = await res.json();
                return data.cicilan || []; // Array cicilan (Angsuran 0, 1, 2...)
            } catch (e) {
                return [];
            }
        }

        // 3. Render HTML untuk Kartu Transaksi
        function renderTransactionCard(order, cicilanList) {
            const container = document.getElementById('transactionContainer');
            
            // Hitung Progress
            const totalBayar = cicilanList
                .filter(c => c.status === 'lunas')
                .reduce((sum, c) => sum + parseFloat(c.nominal), 0);
            const totalHarga = parseFloat(order.total_harga);
            const progress = (totalBayar / totalHarga) * 100;
            const sisaTagihan = totalHarga - totalBayar;

            // Generate HTML
            const card = document.createElement('div');
            card.className = 'transaction-card';
            
            // Gambar Hewan (Fallback jika null)
            const imgUrl = order.gambar ? `/uploads/hewan/${order.gambar}` : 'images/default-hewan.jpg';

            card.innerHTML = `
                <div class="transaction-header" onclick="toggleDetail(${order.id})">
                    <img src="${imgUrl}" class="hewan-thumb" alt="Hewan">
                    
                    <div class="transaction-info">
                        <div class="transaction-title">
                            ${order.jenis_hewan} <span style="font-size: 0.8em; color: var(--accent-green);">#${order.id}</span>
                        </div>
                        
                        <div class="transaction-meta">
                            <span><i class="fas fa-tag"></i> Total: Rp ${formatRupiah(order.total_harga)}</span>
                            <span><i class="fas fa-coins"></i> Sisa: Rp ${formatRupiah(sisaTagihan)}</span>
                        </div>

                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                            <span style="font-size: 0.8rem; color: var(--accent-green);">${Math.round(progress)}% Lunas</span>
                        </div>
                    </div>

                    <div style="text-align: right;">
                        <button class="btn-secondary" style="background: transparent; border: 1px solid var(--accent-green); color: var(--accent-green); border-radius: 20px; padding: 5px 15px;">
                            Lihat Rincian <i class="fas fa-chevron-down toggle-icon" id="icon-${order.id}"></i>
                        </button>
                    </div>
                </div>

                <div id="detail-${order.id}" class="installment-list">
                    ${renderInstallmentList(order.id, cicilanList)}
                </div>
            `;

            container.appendChild(card);
        }

        // 4. Render Daftar Item Cicilan (Angsuran 0 - 12)
        function renderInstallmentList(orderId, list) {
            if (!list || list.length === 0) return '<p class="text-center">Data jadwal belum tersedia.</p>';

            return list.map(item => {
                const isPaid = item.status === 'lunas';
                const isVerif = item.status === 'menunggu_verifikasi';
                const isLate = !isPaid && !isVerif && new Date(item.jatuh_tempo) < new Date();
                
                let statusBadge = '';
                let actionBtn = '';

                // Logika Status & Tombol
                if (isPaid) {
                    statusBadge = `<span class="status-badge badge-lunas"><i class="fas fa-check"></i> Lunas</span>`;
                    actionBtn = `<small style="color: var(--text-gray);">Tgl Bayar: ${formatDate(item.tanggal_bayar)}</small>`;
                } else if (isVerif) {
                    statusBadge = `<span class="status-badge badge-verif"><i class="fas fa-clock"></i> Verifikasi</span>`;
                    actionBtn = `<small style="color: var(--text-gray);">Menunggu Konfirmasi Admin</small>`;
                } else {
                    const statusClass = isLate ? 'badge-pending' : 'badge-pending'; // Bisa bedakan warna kalau mau
                    const statusText = isLate ? 'Telat' : 'Belum Bayar';
                    const icon = isLate ? 'exclamation-circle' : 'hourglass-half';
                    
                    statusBadge = `<span class="status-badge ${statusClass}" style="${isLate ? 'color: #e74c3c; background: rgba(231,76,60,0.2)' : ''}"><i class="fas fa-${icon}"></i> ${statusText}</span>`;
                    
                    // Tombol Bayar
                    actionBtn = `
                        <button onclick="openBayarModal(${orderId}, ${item.angsuran_ke}, ${item.nominal}, '${item.jatuh_tempo}')" 
                            style="background: var(--accent-green); color: black; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                            <i class="fas fa-wallet"></i> Bayar
                        </button>
                    `;
                }

                const label = item.angsuran_ke === 0 ? "DP" : `Bulan ${item.angsuran_ke}`;
                const itemClass = isPaid ? 'item-lunas' : (isLate ? 'item-telat' : '');

                return `
                    <div class="installment-item ${itemClass}">
                        <div class="month-indicator">
                            <div class="month-circle">${item.angsuran_ke}</div>
                            <div>
                                <div style="font-weight: bold; color: white;">${label}</div>
                                <div style="font-size: 0.85rem; color: var(--text-gray);">
                                    Jatuh Tempo: ${formatDate(item.jatuh_tempo)}
                                </div>
                            </div>
                        </div>

                        <div style="text-align: right; min-width: 120px;">
                            <div style="font-size: 1.1rem; font-weight: bold; color: var(--accent-green); margin-bottom: 5px;">
                                Rp ${formatRupiah(item.nominal)}
                            </div>
                            ${statusBadge}
                        </div>

                        <div style="margin-left: 20px;">
                            ${actionBtn}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 5. Accordion Toggle Logic
        window.toggleDetail = function(id) {
            const detailDiv = document.getElementById(`detail-${id}`);
            const icon = document.getElementById(`icon-${id}`);
            const parent = detailDiv.parentElement; // .transaction-card

            if (detailDiv.style.display === 'block') {
                detailDiv.style.display = 'none';
                parent.classList.remove('expanded');
            } else {
                detailDiv.style.display = 'block';
                parent.classList.add('expanded');
            }
        };

        // 6. Modal Functions
        window.openBayarModal = function(pesananId, angsuranKe, nominal, jatuhTempo) {
            document.getElementById('modalPesananId').value = pesananId;
            document.getElementById('modalAngsuranKe').value = angsuranKe;
            document.getElementById('modalNominal').innerText = 'Rp ' + formatRupiah(nominal);
            document.getElementById('modalInfoJatuhTempo').innerText = 'Jatuh Tempo: ' + formatDate(jatuhTempo);
            document.getElementById('modalBayar').style.display = 'flex';
        }

        window.closeModal = function() {
            document.getElementById('modalBayar').style.display = 'none';
            document.getElementById('formBayarCicilan').reset();
        }

        // 7. Handle Submit Bayar
        document.getElementById('formBayarCicilan').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btn = document.getElementById('btnSubmitBayar');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Mengirim...';
            btn.disabled = true;

            const pesananId = document.getElementById('modalPesananId').value;
            const angsuranKe = document.getElementById('modalAngsuranKe').value;
            const fileInput = document.getElementById('modalBukti');
            
            const formData = new FormData();
            formData.append('bukti', fileInput.files[0]);

            try {
                // Perhatikan: Endpoint ini harus ada di server.js (Lihat instruksi di bawah)
                const res = await fetch(`/api/pesanan/${pesananId}/cicilan/${angsuranKe}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await res.json();
                
                if (res.ok) {
                    alert('✅ Bukti pembayaran berhasil dikirim! Menunggu verifikasi admin.');
                    closeModal();
                    loadTransactions(); // Reload data
                } else {
                    throw new Error(data.message || data.error);
                }
            } catch (err) {
                alert('❌ Gagal: ' + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Helpers
        function formatRupiah(num) {
            return parseInt(num).toLocaleString('id-ID');
        }
        function formatDate(dateStr) {
            if(!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
        }
    </script>
</body>
</html>